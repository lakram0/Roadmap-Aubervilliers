<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aubervilliers - Dashboard Final</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-main: #0b1220;
      --bg-panel: #111a2e;
      --card-bg: #1a2639;
      --text-light: #e8eefc;
      --text-muted: #8b9bbd;
      --accent: #00d2ff;
      --border: rgba(255,255,255,0.1);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: 'Segoe UI', sans-serif;
      background: var(--bg-main); color: var(--text-light);
      height: 100vh; display: flex; flex-direction: column;
    }

    /* HEADER */
    header {
      padding: 0 20px; height: 50px; background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    header h1 { font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; margin: 0; }

    /* LAYOUT */
    .layout { display: flex; height: calc(100vh - 50px); overflow: hidden; }

    /* SIDEBAR (GAUCHE) */
    .sidebar {
      width: 420px; background: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      flex-shrink: 0;
      overflow-y: auto; /* Permet de scroller toute la barre latérale */
    }

    /* SECTION 1 : DASHBOARD (Les 3 Graphes) */
    .dashboard-panel {
      padding: 15px;
      background: #0f1623;
      border-bottom: 1px solid var(--border);
    }
    .panel-title { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 15px; font-weight: bold; border-left: 3px solid var(--accent); padding-left: 10px; }

    /* Grille pour les chiffres */
    .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .kpi-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; text-align: center; }
    .kpi-val { font-size: 1.2rem; font-weight: bold; color: white; }
    .kpi-label { font-size: 0.7rem; color: var(--text-muted); }

    /* Conteneurs des Graphes (FIXED HEIGHT pour éviter les bugs d'affichage) */
    .charts-wrapper { display: flex; flex-direction: column; gap: 20px; }
    
    .chart-box {
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      padding: 10px;
      border: 1px solid var(--border);
    }
    .chart-title { font-size: 0.75rem; text-align: center; margin-bottom: 5px; color: #ccc; }
    
    .canvas-container {
      position: relative;
      height: 160px; /* Hauteur forcée pour éviter l'overlap */
      width: 100%;
    }

    /* SECTION 2 : LISTE DES PHOTOS */
    .list-container { padding: 15px; }
    
    .spot-card {
      background: var(--card-bg); border-radius: 8px; padding: 10px;
      margin-bottom: 12px; display: flex; gap: 10px;
      border: 1px solid transparent; cursor: pointer; transition: 0.2s;
    }
    .spot-card:hover, .spot-card.active { border-color: var(--accent); background: #23304a; }
    
    .spot-img { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; flex-shrink: 0; }
    .spot-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .spot-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 4px; }
    .spot-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 8px; }
    .badge { padding: 2px 6px; border-radius: 4px; background: rgba(0, 210, 255, 0.1); color: var(--accent); }

    /* MAP */
    #map { flex: 1; height: 100%; background: #0b1220; }

    /* POPUP */
    .leaflet-popup-content-wrapper { background: var(--bg-panel); color: white; }
    .leaflet-popup-tip { background: var(--bg-panel); }
    .popup-img { width: 100%; border-radius: 4px; margin-bottom: 5px; }

    /* Responsive mobile */
    @media (max-width: 768px) {
      .layout { flex-direction: column-reverse; }
      .sidebar { width: 100%; height: 50vh; }
    }
  </style>
</head>
<body>

  <header>
    <h1>Données Aubervilliers</h1>
    <span style="font-size:0.8rem; color:var(--accent);">● Live Dashboard</span>
  </header>

  <div class="layout">
    
    <aside class="sidebar">
      
      <div class="dashboard-panel">
        <div class="panel-title">Analyse Globale</div>

        <div class="kpi-grid">
          <div class="kpi-box">
            <div class="kpi-val">17</div>
            <div class="kpi-label">Étapes</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-val">3</div>
            <div class="kpi-label">Typologies</div>
          </div>
        </div>

        <div class="charts-wrapper">
          
          <div class="chart-box">
            <div class="chart-title">Répartition des Sentiments</div>
            <div class="canvas-container">
              <canvas id="chart1"></canvas>
            </div>
          </div>

          <div class="chart-box">
            <div class="chart-title">Typologie des Espaces</div>
            <div class="canvas-container">
              <canvas id="chart2"></canvas>
            </div>
          </div>

          <div class="chart-box">
            <div class="chart-title">Rythme & Densité du Parcours</div>
            <div class="canvas-container">
              <canvas id="chart3"></canvas>
            </div>
          </div>

        </div>
      </div>

      <div class="list-container" id="cards-list">
        <div class="panel-title">Timeline du Parcours</div>
        </div>
    </aside>

    <main id="map"></main>
  </div>

<script>
  // --- DONNÉES ENRICHIES (Avec Type et Densité pour les graphes) ---
  const data = [
    { id: 1, file: "images/photo04.jpg", title: "Humathèque", coords: [48.9105, 2.3660], type: "Architecture", density: 3, sentiment: "Moderne", color: "#3498DB", desc: "Architecture blanche clinique, lignes épurées." },
    { id: 2, file: "images/photo02.jpg", title: "MSH Paris Nord", coords: [48.9112, 2.3655], type: "Architecture", density: 6, sentiment: "Graphique", color: "#A93226", desc: "Rythme vertical des brise-soleil et arbre rouge." },
    { id: 3, file: "images/photo03.jpg", title: "Allée Platanes", coords: [48.9115, 2.3670], type: "Urbain", density: 7, sentiment: "Urbain", color: "#F1C40F", desc: "Perspective urbaine verte avec signalétique." },
    { id: 4, file: "images/photo10.jpg", title: "Contre-jour", coords: [48.9120, 2.3680], type: "Nature", density: 2, sentiment: "Espoir", color: "#F39C12", desc: "Lumière traversant les branches." },
    { id: 5, file: "images/photo17.jpg", title: "Rayons & Bâtiment", coords: [48.9121, 2.3681], type: "Architecture", density: 4, sentiment: "Éblouissant", color: "#FFFFFF", desc: "Soleil éclatant sur façade vitrée." },
    { id: 6, file: "images/photo09.jpg", title: "Canopée Jaune", coords: [48.9122, 2.3682], type: "Nature", density: 3, sentiment: "Chaud", color: "#D35400", desc: "Feuillage dense d'automne." },
    { id: 7, file: "images/photo12.jpg", title: "Fresque Murale", coords: [48.9124, 2.3683], type: "Art", density: 8, sentiment: "Artistique", color: "#8E44AD", desc: "Street art coloré au sol." },
    { id: 8, file: "images/photo05.jpg", title: "Parc (Ombres)", coords: [48.9125, 2.3685], type: "Nature", density: 1, sentiment: "Paisible", color: "#1E8449", desc: "Chemin calme en terre battue." },
    { id: 9, file: "images/photo08.jpg", title: "Grand Arbre", coords: [48.9126, 2.3688], type: "Nature", density: 3, sentiment: "Nature", color: "#145A32", desc: "Silhouette d'arbre contre le ciel." },
    { id: 10, file: "images/photo06.jpg", title: "Statue Taureau", coords: [48.9128, 2.3690], type: "Art", density: 5, sentiment: "Curieux", color: "#7D6608", desc: "Sculpture en bronze texturé." },
    { id: 11, file: "images/photo07.jpg", title: "Plaque 'Camille'", coords: [48.9128, 2.3691], type: "Art", density: 2, sentiment: "Détail", color: "#95A5A6", desc: "Signature de l'artiste au sol." },
    { id: 12, file: "images/photo11.jpg", title: "Campus Vert", coords: [48.9130, 2.3695], type: "Nature", density: 4, sentiment: "Ouvert", color: "#2ECC71", desc: "Pelouse et bâtiments modernes." },
    { id: 13, file: "images/photo16.jpg", title: "Esplanade", coords: [48.9132, 2.3698], type: "Urbain", density: 4, sentiment: "Vaste", color: "#5DADE2", desc: "Grand espace ouvert sous le ciel." },
    { id: 14, file: "images/photo01.jpg", title: "Vieux Aubervilliers", coords: [48.9135, 2.3700], type: "Architecture", density: 9, sentiment: "Historique", color: "#A93226", desc: "Façade ancienne en pierre meulière." },
    { id: 15, file: "images/photo14.jpg", title: "Hall Entrée", coords: [48.9140, 2.3665], type: "Intérieur", density: 5, sentiment: "Accueil", color: "#BDC3C7", desc: "Grand hall lumineux." },
    { id: 16, file: "images/photo13.jpg", title: "Atrium (Bas)", coords: [48.9142, 2.3665], type: "Intérieur", density: 4, sentiment: "Aérien", color: "#AED6F1", desc: "Verrière et suspensions." },
    { id: 17, file: "images/photo15.jpg", title: "Atrium (Haut)", coords: [48.9145, 2.3665], type: "Intérieur", density: 7, sentiment: "Complexe", color: "#5D6D7E", desc: "Passerelles et vitres." }
  ];

  // --- INIT CARTE ---
  const map = L.map('map').setView([48.9125, 2.3680], 16);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'OSM' }).addTo(map);

  const markers = {};
  const path = [];
  const list = document.getElementById('cards-list');

  // --- GÉNÉRATION LISTE + MARQUEURS ---
  data.forEach(item => {
    // Liste
    const el = document.createElement('div');
    el.className = 'spot-card';
    el.id = `card-${item.id}`;
    el.onclick = () => focusMap(item.id);
    el.innerHTML = `
      <img src="${item.file}" class="spot-img" onerror="this.src='https://placehold.co/70'">
      <div class="spot-info">
        <div class="spot-title">${item.id}. ${item.title}</div>
        <div class="spot-meta">
          <span class="badge" style="color:${item.color}">${item.sentiment}</span>
          <span>${item.type}</span>
        </div>
      </div>
    `;
    list.appendChild(el);

    // Marqueur
    const m = L.circleMarker(item.coords, { color: '#00d2ff', fillColor: item.color, fillOpacity: 0.8, radius: 7 }).addTo(map);
    m.bindPopup(`<b>${item.title}</b><br><img src="${item.file}" class="popup-img"><br>${item.desc}`);
    markers[item.id] = m;
    path.push(item.coords);
  });

  L.polyline(path, { color: '#00d2ff', dashArray: '5,5', opacity: 0.5 }).addTo(map);
  map.fitBounds(path, { padding: [50, 50] });

  function focusMap(id) {
    const m = markers[id];
    map.setView(m.getLatLng(), 18);
    m.openPopup();
    document.querySelectorAll('.spot-card').forEach(c => c.classList.remove('active'));
    document.getElementById(`card-${id}`).classList.add('active');
  }

  // --- CONFIGURATION DES 3 GRAPHES (Chart.js) ---
  
  // 1. Préparer les données
  const sentimentCounts = {};
  const typeCounts = {};
  const densityData = data.map(d => d.density);
  const labels = data.map(d => d.id);

  data.forEach(d => {
    sentimentCounts[d.sentiment] = (sentimentCounts[d.sentiment] || 0) + 1;
    typeCounts[d.type] = (typeCounts[d.type] || 0) + 1;
  });

  // Graphe 1 : SENTIMENTS (Doughnut)
  new Chart(document.getElementById('chart1'), {
    type: 'doughnut',
    data: {
      labels: Object.keys(sentimentCounts),
      datasets: [{
        data: Object.values(sentimentCounts),
        backgroundColor: ['#3498DB', '#E74C3C', '#F1C40F', '#2ECC71', '#9B59B6', '#E67E22', '#BDC3C7', '#8E44AD'],
        borderWidth: 0
      }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#ccc', boxWidth: 10, font: {size: 10} } } } }
  });

  // Graphe 2 : TYPES D'ESPACES (Bar Horizontal)
  new Chart(document.getElementById('chart2'), {
    type: 'bar',
    data: {
      labels: Object.keys(typeCounts),
      datasets: [{
        label: 'Nombre de photos',
        data: Object.values(typeCounts),
        backgroundColor: '#00d2ff',
        borderRadius: 4
      }]
    },
    options: { 
      indexAxis: 'y',
      responsive: true, maintainAspectRatio: false, 
      plugins: { legend: { display: false } },
      scales: { x: { ticks: { color: '#8b9bbd' } }, y: { ticks: { color: '#fff' } } }
    }
  });

  // Graphe 3 : DENSITÉ (Line)
  new Chart(document.getElementById('chart3'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Densité',
        data: densityData,
        borderColor: '#ff00d4',
        backgroundColor: 'rgba(255, 0, 212, 0.1)',
        tension: 0.4, fill: true, pointRadius: 2
      }]
    },
    options: { 
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { x: { display: false }, y: { display: false, min: 0 } }
    }
  });

</script>
</body>
</html>
