<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aubervilliers - Analyse Finale</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-main: #0b1220;
      --bg-panel: #111a2e;
      --card-bg: #1a2639;
      --text-light: #e8eefc;
      --text-muted: #8b9bbd;
      --accent: #00d2ff;
      --border: rgba(255,255,255,0.1);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: 'Segoe UI', sans-serif;
      background: var(--bg-main); color: var(--text-light);
      height: 100vh; display: flex; flex-direction: column;
      overflow: hidden; /* Empêche le scroll global */
    }

    /* HEADER */
    header {
      flex-shrink: 0;
      padding: 0 20px; height: 50px; background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      z-index: 1000;
    }
    header h1 { font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; margin: 0; }

    /* LAYOUT PRINCIPAL */
    .layout { 
      display: flex; 
      height: calc(100vh - 50px); /* Prend tout le reste de la hauteur */
      width: 100%;
      overflow: hidden;
    }

    /* SIDEBAR (GAUCHE) */
    .sidebar {
      width: 500px; /* Plus large pour éviter le chevauchement */
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      flex-shrink: 0;
      overflow-y: auto; /* Scroll uniquement ici */
      z-index: 500;
    }

    /* ZONE GRAPHES (CORRIGÉE) */
    .dashboard-panel { 
      padding: 20px; 
      background: #0f1623; 
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    
    .charts-wrapper { 
      display: flex; 
      flex-direction: column; 
      gap: 20px; 
    }
    
    .chart-row { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 15px; 
      align-items: start;
    }
    
    .chart-box { 
      background: rgba(255,255,255,0.02); 
      border-radius: 8px; 
      padding: 10px; 
      border: 1px solid var(--border);
      overflow: hidden; /* Coupe ce qui dépasse */
    }
    
    .chart-title { 
      font-size: 0.75rem; 
      text-align: center; 
      margin-bottom: 8px; 
      color: #ccc; 
      text-transform: uppercase;
      font-weight: bold;
    }
    
    /* Conteneur Canvas FIXE pour éviter les bugs */
    .canvas-container-big { position: relative; height: 180px; width: 100%; }
    .canvas-container-small { position: relative; height: 140px; width: 100%; }

    /* LISTE PHOTOS */
    .list-container { padding: 20px; }
    .section-title { font-size: 0.9rem; color: var(--accent); text-transform: uppercase; margin: 0 0 15px 0; font-weight: bold; border-bottom: 1px solid var(--border); padding-bottom: 5px; }

    .spot-card {
      background: var(--card-bg); border-radius: 8px; padding: 12px;
      margin-bottom: 15px; border: 1px solid transparent; 
      cursor: pointer; transition: 0.2s;
    }
    .spot-card:hover, .spot-card.active { border-color: var(--accent); background: #23304a; }

    .card-header { display: flex; gap: 15px; margin-bottom: 10px; }
    .spot-img { width: 90px; height: 90px; object-fit: cover; border-radius: 6px; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.2); }
    
    .spot-title { font-size: 1.1rem; font-weight: 600; color: white; margin-bottom: 5px; }
    .spot-desc { font-size: 0.85rem; color: #ccc; line-height: 1.4; margin-bottom: 10px; font-style: italic; }
    
    .meta-grid { 
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px; 
      font-size: 0.75rem; color: var(--text-muted); background: rgba(0,0,0,0.2); 
      padding: 8px; border-radius: 4px;
    }
    .color-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; border: 1px solid #fff; }

    /* MAP */
    #map { 
      flex: 1; /* Prend tout l'espace restant */
      height: 100%; 
      background: #0b1220; 
      z-index: 1; /* Reste derrière la sidebar */
    }

    /* POPUP */
    .leaflet-popup-content-wrapper { background: var(--bg-panel); color: white; border: 1px solid var(--accent); border-radius: 8px; }
    .leaflet-popup-tip { background: var(--bg-panel); border-top: 1px solid var(--accent); }
    .popup-wrapper { width: 260px; }
    .popup-img { width: 100%; border-radius: 6px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.2); }

    @media (max-width: 900px) {
      .layout { flex-direction: column-reverse; }
      .sidebar { width: 100%; height: 50vh; }
    }
  </style>
</head>
<body>

  <header>
    <h1>Aubervilliers — Analyse Finale</h1>
    <span style="font-size:0.8rem; color:var(--accent);">Dashboard Interactif</span>
  </header>

  <div class="layout">
    
    <aside class="sidebar">
      
      <div class="dashboard-panel">
        <div class="section-title">Analyse des Données</div>
        
        <div class="charts-wrapper">
          <div class="chart-box">
            <div class="chart-title">Répartition des Sentiments</div>
            <div class="canvas-container-big">
              <canvas id="chart1"></canvas>
            </div>
          </div>
          
          <div class="chart-row">
            <div class="chart-box">
              <div class="chart-title">Typologies</div>
              <div class="canvas-container-small">
                <canvas id="chart2"></canvas>
              </div>
            </div>
            
            <div class="chart-box">
              <div class="chart-title">Densité (Rythme)</div>
              <div class="canvas-container-small">
                <canvas id="chart3"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="list-container" id="cards-list">
        <div class="section-title">Détail des 17 Étapes</div>
        </div>
    </aside>

    <main id="map"></main>
  </div>

<script>
  // --- DONNÉES COMPLÈTES (17 Photos) ---
  const data = [
    { id: 1, file: "images/photo04.jpg", title: "Humathèque", coords: [48.9105, 2.3660], type: "Architecture", density: 3, sentiment: "Moderne", dims: "3024x4032", color: "#3498DB", desc: "Architecture blanche clinique, lignes épurées. Contraste fort avec le ciel bleu." },
    { id: 2, file: "images/photo02.jpg", title: "MSH Paris Nord", coords: [48.9112, 2.3655], type: "Architecture", density: 6, sentiment: "Graphique", dims: "3024x4032", color: "#A93226", desc: "Rythme vertical des brise-soleil et présence organique de l'arbre rouge." },
    { id: 3, file: "images/photo03.jpg", title: "Allée Platanes", coords: [48.9115, 2.3670], type: "Urbain", density: 7, sentiment: "Urbain", dims: "3024x4032", color: "#F1C40F", desc: "Perspective urbaine verte avec signalétique routière marquante." },
    { id: 4, file: "images/photo10.jpg", title: "Contre-jour", coords: [48.9120, 2.3680], type: "Nature", density: 2, sentiment: "Espoir", dims: "3024x4032", color: "#F39C12", desc: "Lumière divine traversant les branches, créant une ambiance mystique." },
    { id: 5, file: "images/photo17.jpg", title: "Rayons & Bâtiment", coords: [48.9121, 2.3681], type: "Architecture", density: 4, sentiment: "Éblouissant", dims: "3024x4032", color: "#FFFFFF", desc: "Soleil éclatant se reflétant sur la façade vitrée moderne." },
    { id: 6, file: "images/photo09.jpg", title: "Canopée Jaune", coords: [48.9122, 2.3682], type: "Nature", density: 3, sentiment: "Chaud", dims: "3024x4032", color: "#D35400", desc: "Texture dense du feuillage d'automne en contre-plongée." },
    { id: 7, file: "images/photo12.jpg", title: "Fresque Murale", coords: [48.9124, 2.3683], type: "Art", density: 8, sentiment: "Artistique", dims: "3024x4032", color: "#8E44AD", desc: "Street art coloré au sol, apportant du dynamisme au béton." },
    { id: 8, file: "images/photo05.jpg", title: "Parc (Ombres)", coords: [48.9125, 2.3685], type: "Nature", density: 1, sentiment: "Paisible", dims: "3024x4032", color: "#1E8449", desc: "Chemin calme en terre battue avec jeux d'ombres longues." },
    { id: 9, file: "images/photo08.jpg", title: "Grand Arbre", coords: [48.9126, 2.3688], type: "Nature", density: 3, sentiment: "Nature", dims: "3024x4032", color: "#145A32", desc: "Silhouette majestueuse d'un arbre contre le ciel bleu." },
    { id: 10, file: "images/photo06.jpg", title: "Statue Taureau", coords: [48.9128, 2.3690], type: "Art", density: 5, sentiment: "Curieux", dims: "3024x4032", color: "#7D6608", desc: "Sculpture en bronze texturé représentant un taureau (R. Khimoune)." },
    { id: 11, file: "images/photo07.jpg", title: "Plaque 'Camille'", coords: [48.9128, 2.3691], type: "Art", density: 2, sentiment: "Détail", dims: "3024x4032", color: "#95A5A6", desc: "Signature de l'artiste ancrée dans le sol, détail historique." },
    { id: 12, file: "images/photo11.jpg", title: "Campus Vert", coords: [48.9130, 2.3695], type: "Nature", density: 4, sentiment: "Ouvert", dims: "3024x4032", color: "#2ECC71", desc: "Vaste pelouse verte entourée de bâtiments universitaires récents." },
    { id: 13, file: "images/photo16.jpg", title: "Esplanade", coords: [48.9132, 2.3698], type: "Urbain", density: 4, sentiment: "Vaste", dims: "3024x4032", color: "#5DADE2", desc: "Grand espace ouvert minéral sous un ciel immense." },
    { id: 14, file: "images/photo01.jpg", title: "Vieux Aubervilliers", coords: [48.9135, 2.3700], type: "Architecture", density: 9, sentiment: "Historique", dims: "3024x4032", color: "#A93226", desc: "Façade traditionnelle en pierre meulière, typique de la banlieue." },
    { id: 15, file: "images/photo14.jpg", title: "Hall Entrée", coords: [48.9140, 2.3665], type: "Intérieur", density: 5, sentiment: "Accueil", dims: "3024x4032", color: "#BDC3C7", desc: "Grand hall lumineux invitant à l'entrée." },
    { id: 16, file: "images/photo13.jpg", title: "Atrium (Bas)", coords: [48.9142, 2.3665], type: "Intérieur", density: 4, sentiment: "Aérien", dims: "3024x4032", color: "#AED6F1", desc: "Verrière et suspensions modernes vues en contre-plongée." },
    { id: 17, file: "images/photo15.jpg", title: "Atrium (Haut)", coords: [48.9145, 2.3665], type: "Intérieur", density: 7, sentiment: "Complexe", dims: "3024x4032", color: "#5D6D7E", desc: "Jeu complexe de passerelles vitrées et de transparence." }
  ];

  // --- INIT CARTE ---
  const map = L.map('map').setView([48.9125, 2.3680], 16);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'OSM' }).addTo(map);

  const markers = {};
  const path = [];
  const list = document.getElementById('cards-list');

  // --- GÉNÉRATION ---
  data.forEach(item => {
    
    // Carte Liste
    const el = document.createElement('div');
    el.className = 'spot-card';
    el.id = `card-${item.id}`;
    el.onclick = () => focusMap(item.id);
    
    el.innerHTML = `
      <div class="card-header">
        <img src="${item.file}" class="spot-img" onerror="this.src='https://placehold.co/80'">
        <div style="flex:1">
          <div class="spot-title">${item.title}</div>
          <div class="meta-grid">
            <span><b>#${item.id}</b> | ${item.sentiment}</span>
            <span><span class="color-dot" style="background:${item.color}"></span></span>
          </div>
        </div>
      </div>
      <div class="spot-desc">${item.desc}</div>
      <div class="meta-grid">
        <span><b>Dim:</b> ${item.dims}</span>
        <span><b>Type:</b> ${item.type}</span>
      </div>
    `;
    list.appendChild(el);

    // Marker
    const m = L.circleMarker(item.coords, { color: '#00d2ff', fillColor: item.color, fillOpacity: 0.9, radius: 8 }).addTo(map);
    m.bindPopup(`
      <div class="popup-wrapper">
        <div class="popup-title">${item.id}. ${item.title}</div>
        <img src="${item.file}" class="popup-img">
        <div class="popup-desc">${item.desc}</div>
      </div>
    `);
    markers[item.id] = m;
    path.push(item.coords);
  });

  L.polyline(path, { color: '#00d2ff', dashArray: '5,5', opacity: 0.5 }).addTo(map);
  map.fitBounds(path, { padding: [50, 50] });

  function focusMap(id) {
    const m = markers[id];
    map.setView(m.getLatLng(), 18);
    m.openPopup();
    document.querySelectorAll('.spot-card').forEach(c => c.classList.remove('active'));
    document.getElementById(`card-${id}`).classList.add('active');
    document.getElementById(`card-${id}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // --- CHART.JS CONFIGURATION (CORRIGÉE) ---
  
  const sentimentCounts = {};
  const typeCounts = {};
  const densityData = data.map(d => d.density);
  const labels = data.map(d => d.id);

  data.forEach(d => {
    sentimentCounts[d.sentiment] = (sentimentCounts[d.sentiment] || 0) + 1;
    typeCounts[d.type] = (typeCounts[d.type] || 0) + 1;
  });

  // Chart 1: Sentiments (Doughnut)
  new Chart(document.getElementById('chart1'), {
    type: 'doughnut',
    data: {
      labels: Object.keys(sentimentCounts),
      datasets: [{
        data: Object.values(sentimentCounts),
        backgroundColor: ['#3498DB', '#E74C3C', '#F1C40F', '#2ECC71', '#9B59B6', '#E67E22', '#BDC3C7', '#8E44AD'],
        borderWidth: 0
      }]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false, 
      plugins: { legend: { position: 'right', labels: { color: '#ccc', boxWidth: 10, font: {size: 9} } } } 
    }
  });

  // Chart 2: Types (Bar)
  new Chart(document.getElementById('chart2'), {
    type: 'bar',
    data: {
      labels: Object.keys(typeCounts),
      datasets: [{
        label: 'Qté',
        data: Object.values(typeCounts),
        backgroundColor: '#00d2ff',
        borderRadius: 3
      }]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false, 
      plugins: { legend: { display: false } },
      scales: { x: { ticks: { color: '#8b9bbd', font:{size:8} } }, y: { display:false } }
    }
  });

  // Chart 3: Densité (Line)
  new Chart(document.getElementById('chart3'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Densité',
        data: densityData,
        borderColor: '#ff00d4',
        backgroundColor: 'rgba(255, 0, 212, 0.1)',
        tension: 0.4, fill: true, pointRadius: 0
      }]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { x: { display: false }, y: { display: false, min: 0, max: 10 } }
    }
  });

</script>
</body>
</html>
